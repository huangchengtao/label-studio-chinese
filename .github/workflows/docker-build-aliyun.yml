# 工作流名称
name: Build and Push Docker Image to Aliyun

# 触发条件：推送到main分支时触发
on:
  push:
    branches: [ main ]
  # 也可以手动触发
  workflow_dispatch:

# 环境变量定义
env:
  ALIYUN_REGISTRY: registry.cn-zhangjiakou.aliyuncs.com  # 阿里云镜像仓库地址
  ALIYUN_USERNAME: bjzyjn  # 阿里云用户名
  IMAGE_NAME: registry.cn-zhangjiakou.aliyuncs.com/compt/lable-studio-chinese  # 完整镜像名称
  FINAL_TAG: latest  # 镜像标签

jobs:
  build-and-push:
    name: Build and Push to Aliyun
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # 步骤1: 检出代码（main分支）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # 明确指定main分支

      # 步骤2: 设置Docker Buildx（支持多架构构建）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3: 登录阿里云容器镜像服务
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ env.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}  # 密码存储在GitHub Secrets中

      # 步骤4: 构建Docker镜像
      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t ${{ env.IMAGE_NAME }}:latest .

      # 步骤5: 推送镜像到阿里云
      - name: Push Docker image
        run: |
          echo "Pushing image to Aliyun..."
          docker push ${{ env.IMAGE_NAME }}:latest
          echo "✅ Image pushed successfully: ${{ env.IMAGE_NAME }}:latest"

      # 步骤6: 验证推送结果（可选）
      - name: Verify pushed image
        run: |
          echo "Verifying image tags..."
          # 列出本地镜像确认构建成功
          docker images | grep "${{ env.ALIYUN_REGISTRY }}/compt"
